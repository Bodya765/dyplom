{% extends 'base.html' %}
{% load static %}

{% block title %}Категорія: {{ category.name }}{% endblock %}

{% block content %}
<main class="category-page">
    <div class="category-container">
        <header class="category-header">
            <h1 class="category-title">{{ category.name }}</h1>
            <p class="category-description">{{ category.description }}</p>
        </header>


        {% if announcements %}
            <div class="announcement-grid" id="announcement-grid">
                {% for announcement in announcements %}
                    <a href="{% url 'announcements:announcement_detail' announcement.id %}" class="announcement-card">
                        <div class="announcement-image-wrapper">
                            <img src="{% if announcement.image %}{{ announcement.image.url }}{% else %}{% static 'default-image.png' %}{% endif %}" alt="{{ announcement.title }}" class="announcement-image">
                        </div>
                        <div class="announcement-info">
                            <h2 class="announcement-title">{{ announcement.title|escape }}</h2>
                            <p class="announcement-price">
                                {{ announcement.price|default:"Не вказано" }} грн
                            </p>
                            <p class="announcement-description">
                                {{ announcement.description|truncatechars:80|default:"Опис відсутній" }}
                            </p>
                            <p class="announcement-location">
                                {{ announcement.location|default:"Невідомо" }}{% if announcement.district %}, {{ announcement.district }}{% endif %}
                            </p>
                        </div>
                    </a>
                {% endfor %}
            </div>

            <!-- Пагінація -->
            <nav class="pagination" role="navigation" aria-label="Пагінація" id="pagination">
                <ul class="pagination-list">
                    {% if announcements.has_previous %}
                        <li><a href="#" class="pagination-link" data-page="1" aria-label="Перша сторінка">«</a></li>
                        <li><a href="#" class="pagination-link" data-page="{{ announcements.previous_page_number }}" aria-label="Попередня сторінка">‹</a></li>
                    {% endif %}
                    <li><span class="pagination-current">Сторінка {{ announcements.number }} із {{ announcements.paginator.num_pages }}</span></li>
                    {% if announcements.has_next %}
                        <li><a href="#" class="pagination-link" data-page="{{ announcements.next_page_number }}" aria-label="Наступна сторінка">›</a></li>
                        <li><a href="#" class="pagination-link" data-page="{{ announcements.paginator.num_pages }}" aria-label="Остання сторінка">»</a></li>
                    {% endif %}
                </ul>
            </nav>
        {% else %}
            <p class="no-announcements" id="no-announcements">Оголошення в цій категорії відсутні або не відповідають фільтрам.</p>
        {% endif %}
    </div>
</main>

<style>
    .category-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        font-family: 'Arial', sans-serif;
    }

    .category-header {
        margin-bottom: 20px;
    }

    .category-title {
        font-size: 2rem;
        color: #3b5998;
        margin-bottom: 10px;
    }

    .category-description {
        font-size: 1rem;
        color: #555;
    }

    .filter-toggle {
        padding: 10px 20px;
        background: #3b5998;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s ease;
    }

    .filter-toggle:hover {
        background: #2a4373;
    }

    .filter-form {
        margin-bottom: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .filter-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-group label {
        font-size: 0.9rem;
        color: #333;
        margin-right: 5px;
    }

    .filter-group select, .filter-group input {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.9rem;
        width: 150px;
    }

    .filter-submit, .filter-reset {
        padding: 5px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.3s ease;
    }

    .filter-submit {
        background: #3b5998;
        color: white;
    }

    .filter-submit:hover {
        background: #2a4373;
    }

    .filter-reset {
        background: #dc3545;
        color: white;
    }

    .filter-reset:hover {
        background: #c82333;
    }

    .announcement-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .announcement-card {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .announcement-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .announcement-image-wrapper {
        width: 100%;
        height: 200px;
        overflow: hidden;
    }

    .announcement-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .announcement-info {
        padding: 15px;
    }

    .announcement-title {
        font-size: 1.2rem;
        color: #3b5998;
        margin-bottom: 5px;
    }

    .announcement-price {
        font-size: 1rem;
        color: #28a745;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .announcement-description {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 5px;
    }

    .announcement-location {
        font-size: 0.85rem;
        color: #777;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination-list {
        display: flex;
        gap: 10px;
        list-style: none;
        padding: 0;
    }

    .pagination-link {
        padding: 5px 10px;
        background: #3b5998;
        color: white;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
    }

    .pagination-link:hover {
        background: #2a4373;
    }

    .pagination-current {
        padding: 5px 10px;
        color: #333;
    }

    .no-announcements {
        text-align: center;
        font-size: 1rem;
        color: #777;
        margin-top: 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterToggle = document.getElementById('filter-toggle');
        const filterForm = document.getElementById('filter-form');
        const filterSubmit = document.getElementById('filter-submit');
        const filterReset = document.getElementById('filter-reset');
        const announcementGrid = document.getElementById('announcement-grid');
        const pagination = document.getElementById('pagination');
        const noAnnouncements = document.getElementById('no-announcements');

        // Показ/приховування форми
        filterToggle.addEventListener('click', function() {
            filterForm.style.display = filterForm.style.display === 'none' || filterForm.style.display === '' ? 'block' : 'none';
        });

        // Застосування фільтрів
        filterSubmit.addEventListener('click', function() {
            updateAnnouncements();
        });

        // Скидання фільтрів
        filterReset.addEventListener('click', function() {
            document.getElementById('sort_by').value = '';
            document.getElementById('price_from').value = '';
            document.getElementById('price_to').value = '';
            updateAnnouncements();
        });

        // Обробка пагінації
        document.querySelectorAll('.pagination-link').forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                const page = this.getAttribute('data-page');
                updateAnnouncements(page);
            });
        });

        // Функція оновлення оголошень
        function updateAnnouncements(page = 1) {
            const formData = new FormData(filterForm);
            formData.append('page', page);

            fetch(window.location.pathname + '?' + new URLSearchParams(formData).toString(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.announcements_html) {
                    announcementGrid.innerHTML = data.announcements_html;
                    pagination.innerHTML = data.pagination_html;
                    noAnnouncements.style.display = 'none';
                    announcementGrid.style.display = 'grid';

                    // Додаємо обробку подій для нових посилань пагінації
                    document.querySelectorAll('.pagination-link').forEach(link => {
                        link.addEventListener('click', function(event) {
                            event.preventDefault();
                            const newPage = this.getAttribute('data-page');
                            updateAnnouncements(newPage);
                        });
                    });
                } else {
                    announcementGrid.style.display = 'none';
                    noAnnouncements.style.display = 'block';
                    noAnnouncements.textContent = 'Оголошення в цій категорії відсутні або не відповідають фільтрам.';
                }
            })
            .catch(error => console.error('Помилка:', error));
        }
    });
</script>
{% endblock %}