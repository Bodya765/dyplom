{% extends "base.html" %}
{% load static %}

{% block title %}{{ announcement.title }}{% endblock %}

{% block content %}
<main class="announcement-detail-page">
    <div class="announcement-main">
        <div class="announcement-content">
            <div class="left-column">
                {% if announcement.image %}
                    <div class="announcement-image-d">
                        <img src="{{ announcement.image.url }}" alt="{{ announcement.title }}" class="announcement-img-det">
                    </div>
                {% endif %}
                {% if announcement.subcategory == "Квартира" %}
                    {% if announcement.apartment_details %}
                        <div class="additional-info">
                            <h3 class="additional-info-title">Додаткова інформація</h3>
                            {% if announcement.apartment_details.seller_type %}
                                <p class="detail-desc"><span>Тип продавця:</span> {{ announcement.apartment_details.seller_type }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.building_type %}
                                <p class="detail-desc"><span>Тип будинку:</span> {{ announcement.apartment_details.building_type }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.residential_complex %}
                                <p class="detail-desc"><span>Назва ЖК:</span> {{ announcement.apartment_details.residential_complex }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.floor %}
                                <p class="detail-desc"><span>Поверх:</span> {{ announcement.apartment_details.floor }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.total_area %}
                                <p class="detail-desc"><span>Загальна площа:</span> {{ announcement.apartment_details.total_area }} м²</p>
                            {% endif %}
                            {% if announcement.apartment_details.kitchen_area %}
                                <p class="detail-desc"><span>Площа кухні:</span> {{ announcement.apartment_details.kitchen_area }} м²</p>
                            {% endif %}
                            {% if announcement.apartment_details.wall_type %}
                                <p class="detail-desc"><span>Тип стін:</span> {{ announcement.apartment_details.wall_type }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.housing_type %}
                                <p class="detail-desc"><span>Тип житла:</span> {{ announcement.apartment_details.housing_type }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.rooms %}
                                <p class="detail-desc"><span>Кількість кімнат:</span> {{ announcement.apartment_details.rooms }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.layout %}
                                <p class="detail-desc"><span>Планування:</span> {{ announcement.apartment_details.layout }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.bathroom %}
                                <p class="detail-desc"><span>Санвузол:</span> {{ announcement.apartment_details.bathroom }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.heating %}
                                <p class="detail-desc"><span>Опалення:</span> {{ announcement.apartment_details.heating }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.renovation %}
                                <p class="detail-desc"><span>Ремонт:</span> {{ announcement.apartment_details.renovation }}</p>
                            {% endif %}
                            {% if announcement.apartment_details.furnishing %}
                                <p class="detail-desc"><span>Меблювання:</span> {{ announcement.apartment_details.furnishing }}</p>
                            {% endif %}
                            <p class="detail-desc">
                                <span>Побутова техніка:</span>
                                {{ announcement.apartment_details.appliances|join:", " }}
                            </p>
                            <p class="detail-desc">
                                <span>Мультимедіа:</span>
                                {{ announcement.apartment_details.multimedia|join:", " }}
                            </p>
                            <p class="detail-desc">
                                <span>Комфорт:</span>
                                {{ announcement.apartment_details.comfort|join:", " }}
                            </p>
                            <p class="detail-desc">
                                <span>Комунікації:</span>
                                {{ announcement.apartment_details.communications|join:", " }}
                            </p>
                            <p class="detail-desc">
                                <span>Інфраструктура:</span>
                                {{ announcement.apartment_details.infrastructure|join:", " }}
                            </p>
                            <p class="detail-desc">
                                <span>Ландшафт:</span>
                                {{ announcement.apartment_details.landscape|join:", " }}
                            </p>
                        </div>
                    {% endif %}
                {% else %}
                {% endif %}
                <span class="detail-desc"><span>Опис:</span> {{ announcement.description }}</span>
            </div>

            <div class="right-column">
                <span class="detail-header">{{ announcement.title }}</span>
                <p class="detail-price">
                    {% if announcement.price %}
                        {{ announcement.price }} грн
                    {% else %}
                        Ціна не вказана
                    {% endif %}
                </p>
                <div class="detail-author">
                    <span class="author-name"><span>Автор:</span> {{ announcement.owner.username }}</span>
                    <!-- Додавання кнопки "Показати номер" -->
                    {% if announcement.owner.profile.phone %}
                        <span class="author-phone">
                            <button id="show-phone-btn" class="btn btn-show-phone">Показати номер</button>
                            <span id="phone-number" class="phone-number" style="display: none;">
                                {{ announcement.owner.profile.phone }}
                            </span>
                        </span>
                    {% else %}
                        <span class="author-phone">Номер телефону не вказано</span>
                    {% endif %}
                    <span class="author-date">
                        <span>Створено:</span> {{ announcement.created_at|date:"d.m.Y H:i" }}
                    </span>
                </div>
                <div class="location-map">
                    <p class="detail-location">
                        <span>Місцезнаходження:</span>
                        {{ announcement.location|default:"Невідомо" }}
                    </p>
                    <div id="map" class="map-container"></div>
                </div>
                {% if user.is_authenticated and user != announcement.owner %}
                    <div class="chat-action">
                        <a href="{% url 'chat:start_chat' announcement.id %}" class="btn btn-primary">Зв’язатися з продавцем</a>
                    </div>
                {% endif %}
                {% if user.is_authenticated and user == announcement.owner %}
                    <div class="actions">
                        <div class="menu">
                            <button class="menu-button" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <div class="menu-dropdown">
                                <a href="{% url 'announcements:edit_announcement' announcement.id %}" class="btn btn-edit">Редагувати</a>
                                <button id="open-delete-modal" class="btn btn-delete">Видалити оголошення</button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Відгуки -->
        <section class="reviews">
            <h2 class="reviews-title">Відгуки</h2>
            <div id="reviews-container">
                {% for review in reviews %}
                    <div class="review">
                        <p class="review-user"><strong>{{ review.user.username }}</strong></p>
                        <p class="review-stars">{{ review.rating }} ★</p>
                        <p class="review-text">{{ review.text }}</p>
                        <p class="review-date"><small>{{ review.created_at|date:" Harrison.m.Y H:i" }}</small></p>
                    </div>
                {% empty %}
                    <p class="no-reviews">Ще немає відгуків.</p>
                {% endfor %}
            </div>
        </section>
        {% if user.is_authenticated %}
            <section class="review-form">
                <h2 class="review-title">Додати відгук</h2>
                <form method="post" action="{% url 'announcements:add_review' announcement.id %}">
                    {% csrf_token %}
                    <label for="rating" class="rating-label">Рейтинг:</label>
                    <div class="star-rating">
                        <input type="hidden" name="rating" id="rating-value" value="0" required>
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <label for="text" class="review-text-label">Відгук:</label>
                    <textarea id="text" name="text" class="review-text" required></textarea>
                    <button type="submit" class="btn btn-primary">Залишити відгук</button>
                </form>
            </section>
        {% endif %}
    </div>

    <!-- Модальне вікно для мапи -->
    <div id="map-modal" class="map-modal">
        <div class="map-modal-content">
            <button class="map-close-btn" aria-label="Закрити карту">✔</button>
            <div id="map-expanded" class="map-expanded"></div>
        </div>
    </div>

    <!-- Модальне вікно для видалення -->
    <div id="delete-modal" class="delete-confirm-modal" style="display: none;">
        <div class="delete-confirm-modal-content">
            <span class="btn-cancel" id="close-modal">✖</span>
            <h3>Підтвердження видалення</h3>
            <p>Ви дійсно хочете видалити це оголошення?</p>
            <button id="confirm-delete-btn" class="btn btn-danger" data-delete-url="{% url 'announcements:delete_announcement' announcement.id %}">Підтвердити видалення</button>
        </div>
    </div>
</main>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const location = "{{ announcement.location|escapejs }}";
    let lat, lon, smallMap, expandedMap;

    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!token) {
            console.error('CSRF-токен не знайдено');
            return '';
        }
        return token.value;
    }

    function initMap(containerId, height, zoom) {
        if (location) {
            const searchQuery = `${location}, Україна`;
            console.log("Шукаємо місце:", searchQuery);

            const cachedCoords = localStorage.getItem(`coords_${searchQuery}`);
            if (cachedCoords) {
                const { lat, lon } = JSON.parse(cachedCoords);
                if (!isNaN(lat) && !isNaN(lon)) {
                    console.log("Використовуємо кешовані координати:", lat, lon);
                    const map = L.map(containerId, {
                        zoomControl: false
                    }).setView([lat, lon], zoom);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    L.marker([lat, lon]).addTo(map)
                        .bindPopup("{{ announcement.location|escapejs }}").openPopup();
                    return map;
                }
            }

            const apiKey = "7d958339ccd968afdbacf3e6ef50174a";
            const geocodeUrl = `http://api.positionstack.com/v1/forward?access_key=${apiKey}&query=${encodeURIComponent(searchQuery)}&country=UA&limit=1`;
            return fetch(geocodeUrl)
                .then(response => response.json())
                .then(data => {
                    console.log("Результат від PositionStack:", data);
                    if (data.data && data.data.length > 0) {
                        lat = parseFloat(data.data[0].latitude);
                        lon = parseFloat(data.data[0].longitude);
                        if (!isNaN(lat) && !isNaN(lon)) {
                            localStorage.setItem(`coords_${searchQuery}`, JSON.stringify({ lat, lon }));
                            const map = L.map(containerId, {
                                zoomControl: false
                            }).setView([lat, lon], zoom);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(map);
                            L.marker([lat, lon]).addTo(map)
                                .bindPopup("{{ announcement.location|escapejs }}").openPopup();
                            return map;
                        }
                    }
                    document.getElementById(containerId).innerHTML = '<p>Місцезнаходження не знайдено</p>';
                })
                .catch(error => {
                    console.error("Помилка запиту до PositionStack:", error);
                    document.getElementById(containerId).innerHTML = '<p>Помилка завантаження карти</p>';
                });
        } else {
            document.getElementById(containerId).innerHTML = '<p>Місцезнаходження не вказано</p>';
        }
    }

    smallMap = initMap('map', 150, 14);

    const mapContainer = document.getElementById('map');
    const modal = document.getElementById('map-modal');
    const closeBtn = document.querySelector('.map-close-btn');
    mapContainer.addEventListener('click', () => {
        modal.style.display = 'flex';
        if (!expandedMap) {
            expandedMap = initMap('map-expanded', 500, 13);
        }
    });
    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            modal.style.display = 'none';
        }
    });

    const stars = document.querySelectorAll(".star");
    const ratingInput = document.getElementById("rating-value");
    stars.forEach(star => {
        star.addEventListener("click", function () {
            const value = this.getAttribute("data-value");
            ratingInput.value = value;
            stars.forEach(s => {
                s.classList.toggle("selected", s.getAttribute("data-value") <= value);
            });
        });
    });

    const menuButton = document.querySelector(".menu-button");
    const menuDropdown = document.querySelector(".menu-dropdown");
    if (menuButton) {
        menuButton.addEventListener("click", () => {
            const expanded = menuButton.getAttribute("aria-expanded") === "true";
            menuButton.setAttribute("aria-expanded", !expanded);
            menuDropdown.style.display = expanded ? "none" : "block";
        });
        document.addEventListener("click", (e) => {
            if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
                menuDropdown.style.display = "none";
                menuButton.setAttribute("aria-expanded", "false");
            }
        });
    }

    const openDeleteModalButton = document.getElementById("open-delete-modal");
    const deleteModal = document.getElementById("delete-modal");
    const closeModalButton = document.getElementById("close-modal");
    const confirmDeleteButton = document.getElementById("confirm-delete-btn");

    if (openDeleteModalButton) {
        openDeleteModalButton.addEventListener("click", () => {
            deleteModal.style.display = "block";
        });
    }

    if (closeModalButton) {
        closeModalButton.addEventListener("click", () => {
            deleteModal.style.display = "none";
        });
    }

    document.addEventListener("click", (e) => {
        if (!deleteModal.contains(e.target) && !openDeleteModalButton.contains(e.target)) {
            deleteModal.style.display = "none";
        }
    });

    confirmDeleteButton.addEventListener("click", () => {
        const deleteUrl = confirmDeleteButton.getAttribute("data-delete-url");
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.href = '/';
            } else {
                alert('Помилка при видаленні оголошення: ' + (data.error || 'Невідома помилка'));
            }
        })
        .catch(error => {
            console.error('Помилка:', error);
            alert('Помилка при видаленні оголошення');
        });
    });

    // Додавання логіки для кнопки "Показати номер"
    const showPhoneButton = document.getElementById("show-phone-btn");
    const phoneNumberElement = document.getElementById("phone-number");

    if (showPhoneButton) {
        showPhoneButton.addEventListener("click", () => {
            showPhoneButton.style.display = "none"; // Ховаємо кнопку
            phoneNumberElement.style.display = "inline"; // Показуємо номер
        });
    }
});
</script>

<style>
    /* Додатковий стиль для приховання модального вікна за замовчуванням */
    #delete-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .delete-confirm-modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        width: 300px;
    }

    .btn-cancel {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }
</style>
{% endblock %}