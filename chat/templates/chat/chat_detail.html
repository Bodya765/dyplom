{% extends 'base.html' %}
{% load static %}

{% block title %}{{ chat.seller.username }}{% endblock %}

{% block content %}
<div class="chat-page">
    <div class="chat-sidebar">
        <h3 class="sidebar-title">Ваші чати</h3>
        <div class="chat-list">
            {% for user_chat in user_chats %}
                <a href="{% url 'chat:chat_detail' user_chat.id %}" class="chat-item {% if user_chat.id == chat.id %}active{% endif %}">
                    <div class="chat-item-avatar">
                        <img src="{% if user_chat.buyer == request.user %}{% if user_chat.seller.profile.avatar %}{{ user_chat.seller.profile.avatar.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}{% else %}{% if user_chat.buyer.profile.avatar %}{{ user_chat.buyer.profile.avatar.url }}{% else %}{% static 'images/default_avatar.png' %}{% endif %}{% endif %}" alt="Avatar">
                    </div>
                    <div class="chat-item-info">
                        <span class="chat-item-name">
                            {% if user_chat.buyer == request.user %}
                                {{ user_chat.seller.username }}
                            {% else %}
                                {{ user_chat.buyer.username }}
                            {% endif %}
                        </span>
                        <span class="chat-item-status" data-status="{% if user_chat.buyer == request.user %}{% if user_chat.seller.status.is_online %}online{% else %}offline{% endif %}{% else %}{% if user_chat.buyer.status.is_online %}online{% else %}offline{% endif %}{% endif %}">
                            <span class="status-dot"></span>
                            {% if user_chat.buyer == request.user %}
                                {% if user_chat.seller.status.is_online %}
                                    Онлайн
                                {% else %}
                                    Офлайн
                                {% endif %}
                            {% else %}
                                {% if user_chat.buyer.status.is_online %}
                                    Онлайн
                                {% else %}
                                    Офлайн
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                </a>
            {% empty %}
                <p class="empty-message">У вас ще немає чатів.</p>
            {% endfor %}
        </div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <h2 class="chat-title">
                Чат з {% if chat.buyer == request.user %}{{ chat.seller.username }}{% else %}{{ chat.buyer.username }}{% endif %}
                <span id="typing-indicator" style="display: none;"> пише...</span>
            </h2>
        </div>
        <div id="chat-messages" class="chat-messages">
            {% for date, messages in messages_by_date.items %}
                <div class="date-divider">{{ date|date:"d.m.Y" }}</div>
                {% for message in messages %}
                    <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                        {% if message.sender != request.user %}
                            <span class="message-sender">{{ message.sender.username }}</span>
                        {% endif %}
                        {% if message.image %}
                            <img src="{{ message.image.url }}" alt="Фото" class="message-image">
                        {% endif %}
                        {% if message.get_content %}
                            <p class="message-content">{{ message.get_content }}</p>
                        {% endif %}
                        <div class="message-meta">
                            <span class="message-timestamp">{{ message.timestamp|date:"H:i" }}</span>
                            {% if message.edited_at %}
                                <span class="message-edited">(редаговано {{ message.edited_at|date:"H:i" }})</span>
                            {% endif %}
                            {% if message.sender == request.user %}
                                <span class="message-status">
                                    {% if message.is_read %}
                                        <span class="read-ticks">✔✔</span>
                                    {% else %}
                                        <span class="unread-ticks">✔✔</span>
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
        <div class="chat-input">
            <textarea id="chat-message-input" rows="2" placeholder="Введіть повідомлення..."></textarea>
            <div class="chat-actions">
                <label for="chat-image-input" class="image-upload-btn">
                    <i class="fas fa-image"></i>
                </label>
                <input type="file" id="chat-image-input" accept="image/*" style="display: none;">
                <button id="chat-message-submit" class="btn btn-primary">Надіслати</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальне вікно для редагування -->
<div id="edit-message-modal" class="edit-modal">
    <div class="modal-content">
        <span class="btn-cancel" id="close-edit-modal">✖</span>
        <h3>Редагувати повідомлення</h3>
        <textarea id="edit-message-input" rows="3"></textarea>
        <button id="save-edit-message" class="btn btn-primary">Зберегти</button>
    </div>
</div>

<!-- Контекстне меню -->
<div id="context-menu" class="context-menu" style="display: none;">
    <div class="context-menu-item" id="context-edit">Редагувати</div>
    <div class="context-menu-item" id="context-delete">Видалити</div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/chat.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat({{ chat.id }}, '{{ request.user.username }}');
            setTimeout(() => {
                if (typeof updateUnreadMessagesCount === 'function') {
                    updateUnreadMessagesCount();
                }
            }, 1000);

            const modal = document.getElementById('edit-message-modal');
            const editInput = document.getElementById('edit-message-input');
            const contextMenu = document.getElementById('context-menu');
            let currentMessageId = null;

            // Функція для приховування контекстного меню
            function hideContextMenu() {
                contextMenu.style.display = 'none';
            }

            // Обробка правої кнопки для контекстного меню
            document.querySelectorAll('.message.sent').forEach(message => {
                message.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    currentMessageId = this.getAttribute('data-message-id');
                    const messageContent = this.querySelector('.message-content').textContent;
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = `${e.pageX}px`;
                    contextMenu.style.top = `${e.pageY}px`;
                });
            });

            // Обробка кліку по пункту "Редагувати" у контекстному меню
            document.getElementById('context-edit').addEventListener('click', function() {
                const messageContent = document.querySelector(`.message[data-message-id="${currentMessageId}"] .message-content`).textContent;
                editInput.value = messageContent;
                modal.style.display = 'block';
                hideContextMenu();
            });

            // Збереження відредагованого повідомлення
            document.getElementById('save-edit-message').onclick = function() {
                const newContent = editInput.value.trim();
                if (newContent) {
                    fetch(`/chat/edit_message/${currentMessageId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ content: newContent })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const messageElement = document.querySelector(`.message[data-message-id="${currentMessageId}"] .message-content`);
                            messageElement.textContent = newContent;
                            const metaElement = document.querySelector(`.message[data-message-id="${currentMessageId}"] .message-meta`);
                            let editedSpan = metaElement.querySelector('.message-edited');
                            if (!editedSpan) {
                                editedSpan = document.createElement('span');
                                editedSpan.className = 'message-edited';
                                metaElement.insertBefore(editedSpan, metaElement.firstChild);
                            }
                            editedSpan.textContent = `(редаговано ${new Date().toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' })})`;
                            modal.style.display = 'none';
                        } else {
                            alert('Помилка при редагуванні повідомлення: ' + (data.error || 'Невідома помилка'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Помилка при редагуванні повідомлення: Перевірте консоль для деталей.');
                    });
                } else {
                    alert('Повідомлення не може бути порожнім.');
                }
            };

            // Закриття модального вікна
            document.getElementById('close-edit-modal').onclick = function() {
                modal.style.display = 'none';
            };

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
                if (!event.target.closest('.context-menu') && !event.target.closest('.message.sent')) {
                    hideContextMenu();
                }
            };

            // Обробка кліку по пункту "Видалити" у контекстному меню
            document.getElementById('context-delete').addEventListener('click', function() {
                if (confirm('Ви впевнені, що хочете видалити це повідомлення?')) {
                    fetch(`/chat/delete_message/${currentMessageId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            const messageElement = document.querySelector(`.message[data-message-id="${currentMessageId}"]`);
                            if (messageElement) {
                                messageElement.remove();
                            }
                        } else {
                            alert('Помилка при видаленні повідомлення: ' + (data.error || 'Невідома помилка'));
                        }
                        hideContextMenu();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Помилка при видаленні повідомлення: Перевірте консоль для деталей.');
                    });
                } else {
                    hideContextMenu();
                }
            });
        });
    </script>
{% endblock %}